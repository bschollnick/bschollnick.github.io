<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>directory_caching &mdash; Directory Caching 1.0.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Directory Caching 1.0.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Directory Caching 1.0.0 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for directory_caching</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">:Module: Directory Caching</span>
<span class="sd">:Date: 2015-02-17</span>
<span class="sd">:Platforms: Mac, Windows, Unix (Tested under Mac OS X)</span>
<span class="sd">:Version: 1</span>
<span class="sd">:Authors:</span>
<span class="sd">    - Benjamin Schollnick</span>


<span class="sd">:Description:</span>
<span class="sd">    Used to cache and speed up Directory listings.  The Gallery project</span>
<span class="sd">    uses it to cache all file and directory information.</span>

<span class="sd">**Modules Used (Batteries Included)**:</span>

<span class="sd">   * os</span>
<span class="sd">   * os.path</span>
<span class="sd">   * stat</span>
<span class="sd">   * string</span>
<span class="sd">   * time</span>

<span class="sd">**Required 3rd Party Modules**:</span>

<span class="sd">   * Scandir - https://github.com/benhoyt/scandir</span>
<span class="sd">        * scandir is a module which provides a generator version of \</span>
<span class="sd">           os.listdir() that also exposes the extra file information the \</span>
<span class="sd">           operating system returns when you iterate a directory. \</span>
<span class="sd">           Generally 2-3 (or more) times faster than the standard library. \</span>
<span class="sd">           (It&#39;s quite noticeable!)</span>

<span class="sd">   * natsort - https://github.com/xolox/python-naturalsort</span>
<span class="sd">        * Used for natural sorting when returning alpha results</span>

<span class="sd">:Concept:</span>
<span class="sd">    The Directory Caching module was the first step in speeding up processing of</span>
<span class="sd">    **massive** directories (2K - 4K) files for the gallery.</span>

<span class="sd">    The first speed up was derived from using Scandir.  The second speed up was</span>
<span class="sd">    due to caching the results, and monitoring for changes.</span>

<span class="sd">    The library uses two methods to expire the cache:</span>

<span class="sd">    1. The library will check for the Modified Times on the Directories.</span>
<span class="sd">       If the directory&#39;s Last Modified time is newer than the last_scanned_time</span>
<span class="sd">       then the directory will be rescanned.</span>
<span class="sd">    2.  If the Directory and/or File count in the directory is different from</span>
<span class="sd">        the last time the directory was scanned, it will be rescanned.</span>

<span class="sd">**Note**:</span>

<span class="sd">* The second method (#2) of expiration does cause a small amount of</span>
<span class="sd">  performance penalty, since it has to rescan the directory, but I have</span>
<span class="sd">  tried to reduce the penalty as much as possible.</span>

<span class="sd">* The library does not normalize the pathnames, I have decided to leave</span>
<span class="sd">  data normalization to the application layer.  The Gallery passes</span>
<span class="sd">  scan_directory strings as .lower().strip() to normalize the data.</span>

<span class="sd">* File Extensions are normalized, as lowercase strings.</span>
<span class="sd">   * There are two different file extensions variables.</span>
<span class="sd">      * ``file_extension`` is the text only (lower case) file extension</span>
<span class="sd">        (e.g. doc)</span>
<span class="sd">      * ``dot_extension`` is the file extension with the separator</span>
<span class="sd">        (e.g. .doc)</span>

<span class="sd">* There are two different filenames variables</span>
<span class="sd">   * ``filename`` contains only the filename of the file</span>
<span class="sd">     (e.g. **spam_spam.doc**)</span>
<span class="sd">   * ``fq_filename`` contains the fully qualified filename of the file\</span>
<span class="sd">     (e.g. **/Users/Shared/tasty/spam_spam.doc**)</span>

<span class="sd">code::</span>

<span class="sd">    cdl = directory_caching.Cache()</span>
<span class="sd">    if not cdl.directory_in_cache(&quot;/Users/Testuser&quot;)</span>
<span class="sd">        cdl.smart_read(&quot;/Users/Testuser&quot;)</span>

<span class="sd">    if not cdl.directory_in_cache(&quot;/Volumes/Gallery/Albums&quot;)</span>
<span class="sd">        cdl.smart_read(&quot;/Volumes/Gallery/Albums&quot;)</span>

<span class="sd">    cached_dirs, cached_files = cdl.return_sorted(</span>
<span class="sd">                    scan_directory=&quot;/Volumes/Gallery/Albums&quot;,</span>
<span class="sd">                    sort_by=SORT_BY_NAME, reverse=False)</span>

<span class="sd">    if cdl.directory_changed(scan_directory=&quot;/Users/Testuser&quot;):</span>
<span class="sd">        cdl.smart_read(&quot;/Users/Testuser&quot;)</span>

<span class="sd">    if cdl.directory_changed(scan_directory=&quot;/Volumes/Gallery/Albums&quot;):</span>
<span class="sd">        cdl.smart_read(&quot;/Volumes/Gallery/Albums&quot;)</span>

<span class="sd">**Note**:</span>

<span class="sd">    smart_read, will check to see if the directory has changed.  So the</span>
<span class="sd">    example above is not optimized.</span>

<span class="sd">        code::</span>

<span class="sd">            if cdl.directory_changed(scan_directory=&quot;/Volumes/Gallery/Albums&quot;):</span>
<span class="sd">                cdl.smart_read(&quot;/Volumes/Gallery/Albums&quot;)</span>

<span class="sd">    Can be rewritten simply as:</span>

<span class="sd">        code::</span>

<span class="sd">            cdl.smart_read(&quot;/Volumes/Gallery/Albums&quot;)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="c">#####################################################</span>
<span class="c">#   Batteries Included imports</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">stat</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c">#   Required third party</span>
<span class="kn">import</span> <span class="nn">natsort</span>  <span class="c"># https://github.com/xolox/python-naturalsort</span>
<span class="kn">import</span> <span class="nn">scandir</span>  <span class="c"># https://github.com/benhoyt/scandir</span>

<span class="n">SORT_BY_NAME</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">SORT_BY_MODIFIED</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">SORT_BY_CREATION</span> <span class="o">=</span> <span class="mi">2</span>
<span class="c">#####################################################</span>
<div class="viewcode-block" id="DirEntry"><a class="viewcode-back" href="../directory_caching.html#directory_caching.DirEntry">[docs]</a><span class="k">class</span> <span class="nc">DirEntry</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        path (str): The path of the file to wrap</span>
<span class="sd">        field_storage (FileStorage): The :class:`FileStorage` instance to wrap</span>
<span class="sd">        temporary (bool): Whether or not to delete the file when the File</span>
<span class="sd">           instance is destructed</span>

<span class="sd">    Returns:</span>
<span class="sd">        BufferedFileStorage: A buffered writable file descriptor</span>

<span class="sd">    The is the template class for the cache objects.</span>
<span class="sd">    Used to store data regarding the files or subdirectories.</span>

<span class="sd">    * Directory Only Data</span>

<span class="sd">       * ``number_files`` - It contains the number of files, \</span>
<span class="sd">            in the directory.</span>
<span class="sd">       * ``number_dirs`` - It contains the number of subdirectories\</span>
<span class="sd">            in the directory.</span>
<span class="sd">       * ``directoryname`` - Contains the directory name (not pathname)</span>
<span class="sd">       * ``filename`` - is blank, the directory equivalent is \</span>
<span class="sd">            directoryname.</span>

<span class="sd">    * Common Data</span>
<span class="sd">       * ``file_extension`` - Contains the file extension of the file\</span>
<span class="sd">            for a directory, &quot;dir&quot; is placed in the file extension.</span>
<span class="sd">       * ``dot_extension`` - See ``file_extension``.  This has the \</span>
<span class="sd">            &quot;.&quot; prefix.  Otherwise identical to ``file_extension``.</span>
<span class="sd">       * ``fq_filename`` - For files, ``fq_filename`` will be the\</span>
<span class="sd">            absolute path to the file.  For directories, fq_filename\</span>
<span class="sd">            will also point to the absolute path to the directory.</span>
<span class="sd">       * ``human_st_mtime`` - This is a human readable last modified</span>
<span class="sd">          * timetime.asctime(time.localtime(data.st[stat.ST_MTIME]))</span>
<span class="sd">       * ``parentdirectory`` - Contains the absolute pathname of the\</span>
<span class="sd">            parent directory that contains the file/directory.</span>
<span class="sd">       * ``st`` - Contains the statistics for the file/directory</span>
<span class="sd">          * ``st_mode`` - FileMode, iNode protection mode</span>
<span class="sd">          * ``st_ino`` - iNode Number</span>
<span class="sd">          * ``st_dev`` - Device iNode resides on</span>
<span class="sd">          * ``st_nlink`` - Number of Links to the iNode</span>
<span class="sd">          * ``st_uid`` - User Id of the Owner</span>
<span class="sd">          * ``st_gid`` - Group id of the owner</span>
<span class="sd">          * ``st_size`` - Size in bytes of file object</span>
<span class="sd">          * ``st_atime`` - Time of last modification</span>
<span class="sd">          * ``st_mtime`` - Last modification time</span>
<span class="sd">          * ``st_ctime`` - creation time, as reported by OS</span>

<span class="sd">    * File only data</span>
<span class="sd">       * ``directoryname`` - Will be Blank (it is not a directory)\</span>
<span class="sd">       * ``filename`` - Contains the filename of the file, for \</span>
<span class="sd">            directories this is blank.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<span class="c">#####################################################</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        structure for storing the data in the cache.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_files</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_dirs</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parentdirectory</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directoryname</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_extension</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dot_extension</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fq_filename</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">st</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">human_st_mtime</span> <span class="o">=</span> <span class="bp">None</span>


<span class="c">#####################################################</span></div>
<div class="viewcode-block" id="Cache"><a class="viewcode-back" href="../directory_caching.html#directory_caching.Cache">[docs]</a><span class="k">class</span> <span class="nc">Cache</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the mainstay of the Directory Caching engine.</span>

<span class="sd">    Establishes the Baseline Settings for the Cache.</span>

<span class="sd">    * ``files_to_ignore`` = [&#39;.ds_store&#39;, &#39;.htaccess&#39;]</span>
<span class="sd">        * Contains a list of filenames that are to be ignored, and not</span>
<span class="sd">          added to cache if they are in a folder.</span>
<span class="sd">        * By default .ds_store, and .htaccess files are ignored.</span>
<span class="sd">        * These items must be lowercased.  Internally all filenames are</span>
<span class="sd">          normalized to lowercase.</span>
<span class="sd">    * ``acceptable_extensions`` = [] # See Note #1</span>
<span class="sd">        * If this is set, this becomes a &quot;reverse&quot; filter. Only files</span>
<span class="sd">          that contain a file extension that is in this list, will be</span>
<span class="sd">          &quot;detected&quot; and cached.</span>
<span class="sd">        * An empty list [], indicates **all** files should be accepted.</span>
<span class="sd">        * By default, all files are allowed / accepted.</span>
<span class="sd">        * As above, these extensions need to be normalized in lowercase.</span>

<span class="sd">    **Note:**</span>

<span class="sd">    1. These are ``file extensions`` (e.g. doc), not dot_extensions</span>
<span class="sd">       (e.g. .doc)</span>

<span class="sd">    &quot;&quot;&quot;</span>
<span class="c">#####################################################</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup and establish the working implementation for directory caching.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># User Changable Settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files_to_ignore</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;.ds_store&#39;</span><span class="p">,</span> <span class="s">&#39;.htaccess&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acceptable_extensions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_filenames</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_path</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="c"># This is the path in the OS that is being examined</span>
            <span class="c">#    (e.g. /Volumes/Users/username/)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_cache</span> <span class="o">=</span> <span class="p">{}</span>


<span class="c">#####################################################</span>
<div class="viewcode-block" id="Cache.clean_filenames"><a class="viewcode-back" href="../directory_caching.html#directory_caching.Cache.clean_filenames">[docs]</a>    <span class="k">def</span> <span class="nf">clean_filenames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fqpathname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        fqpathname (str): The full qualified pathname to examine</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    Check to see if any filenames in the ``fqpathname`` location need</span>
<span class="sd">    to be scrubbed / cleaned.</span>

<span class="sd">    This function uses the ``filter_filenames`` variable/pointer to</span>
<span class="sd">    check and scrub the filenames.</span>

<span class="sd">    If self.filter_filenames is set, this function will call</span>
<span class="sd">    self.filter_filenames to test against the file and directory names.</span>

<span class="sd">    This feature was added for the gallery, to automate the renaming</span>
<span class="sd">    of the directories and files, to ensure that the files and directory</span>
<span class="sd">    names are acceptable to the web server and web browser.</span>

<span class="sd">    By setting a ``filter_filenames`` function, you can use this as you</span>
<span class="sd">    choose.</span>

<span class="sd">    By default, this is not turned on.  This is an opt-in feature.</span>

<span class="sd">    code::</span>

<span class="sd">        import common</span>
<span class="sd">        import file_types</span>
<span class="sd">        self.cdl = directory_caching.Cache()</span>
<span class="sd">        self.cdl.files_to_ignore = file_types.files_to_ignore</span>
<span class="sd">        self.cdl.acceptable_extensions = file_types.image_safe_files</span>
<span class="sd">        self.cdl.filter_filenames = common.clean_filename2</span>
<span class="sd">        print &quot;Priming the cache for %s, please wait&quot; %\</span>
<span class="sd">            file_types.locations[&quot;albums_root&quot;].lower().strip()</span>
<span class="sd">        self.cdl.smart_read(</span>
<span class="sd">            file_types.locations[&quot;albums_root&quot;].lower().strip())</span>
<span class="sd">        print &quot;Pump primed.&quot;</span>

<span class="sd">    After assigning self.cdl.filter_filenames, every time a directory is</span>
<span class="sd">    examined by the caching engine, it will rename the files and directories</span>
<span class="sd">    if an invalid filename or directory name is found.</span>

<span class="sd">    This check is simply a comparison, the filename is passed to the cleaning</span>
<span class="sd">    function, and if the returned filename is different, the file is renamed</span>
<span class="sd">    to the new name.</span>

<span class="sd">    code::</span>

<span class="sd">        if orig_name[1].fq_filename != new_name:</span>
<span class="sd">            os.rename(orig_name[1].fq_filename, new_name)</span>

<span class="sd">    An example cleaning function, from the Gallery application.</span>

<span class="sd">    code::</span>

<span class="sd">        def clean_filename2(filename):</span>
<span class="sd">        replacements = {&#39;&quot;&#39;:&quot;`&quot;, &quot;&#39;&quot;:&quot;`&quot;,</span>
<span class="sd">                        &quot;,&quot;:&quot;&quot;, &quot;#&quot;:&quot;&quot;,</span>
<span class="sd">                        &quot;*&quot;:&quot;&quot;, &quot;@&quot;:&quot;&quot;,</span>
<span class="sd">                        &quot;:&quot;:&quot;-&quot;, &quot;|&quot;:&quot;&quot;}</span>
<span class="sd">        filename = replace_all(urllib2.unquote(filename), replacements)</span>
<span class="sd">            # Un&quot;quotify&quot; the URL / Filename</span>
<span class="sd">        filename = unidecode.unidecode(filename)</span>
<span class="sd">            # de-unicode the filename / url</span>
<span class="sd">        filename, fileext = os.path.splitext(filename)</span>
<span class="sd">        filename = filename.strip() + fileext.strip()</span>
<span class="sd">            # remove extra spaces from filename and file extension.</span>
<span class="sd">            # e.g.  &quot;this is the filename .txt&quot; -&gt; &quot;this is the filename.txt&quot;</span>
<span class="sd">        return filename</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">modified</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_filenames</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory_in_cache</span><span class="p">(</span><span class="n">fqpathname</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">smart_read</span><span class="p">(</span><span class="n">fqpathname</span><span class="p">)</span>

            <span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">dirs</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_sort_name</span><span class="p">(</span><span class="n">scan_directory</span><span class="o">=</span><span class="n">fqpathname</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">orig_name</span> <span class="ow">in</span> <span class="n">files</span><span class="o">+</span><span class="n">dirs</span><span class="p">:</span>
                <span class="n">new_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_filenames</span><span class="p">(</span><span class="n">orig_name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fq_filename</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">orig_name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fq_filename</span> <span class="o">!=</span> <span class="n">new_name</span><span class="p">:</span>
                    <span class="n">modified</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">orig_name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fq_filename</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">modified</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scan_directory_list</span><span class="p">(</span><span class="n">fqpathname</span><span class="p">)</span>

<span class="c">#####################################################</span></div>
    <span class="k">def</span> <span class="nf">_scan_directory_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan_directory</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            scan_directory (str): The fully qualified pathname to examine</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Scan the directory &quot;scan_directory&quot;, and save it to the</span>
<span class="sd">        self.d_cache dictionary.</span>

<span class="sd">        Low Level function, intended to be used by the populate function.</span>

<span class="sd">        scan_directory is matched absolutely, case sensitive,</span>
<span class="sd">        string is stripped(), but otherwise left alone.</span>

<span class="sd">        Highly recommend using a normalization routine on the</span>
<span class="sd">        scan_directory string before sending it to cache.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">directories</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">norm_dir_name</span> <span class="o">=</span> <span class="n">scan_directory</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_cache</span><span class="p">[</span><span class="n">norm_dir_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">s_entry</span> <span class="ow">in</span> <span class="n">scandir</span><span class="o">.</span><span class="n">scandir</span><span class="p">(</span><span class="n">scan_directory</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">DirEntry</span><span class="p">()</span>
            <span class="n">data</span><span class="o">.</span><span class="n">st</span> <span class="o">=</span> <span class="n">s_entry</span><span class="o">.</span><span class="n">lstat</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_filenames</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s_entry</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">s_entry</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">fq_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">scan_directory</span><span class="p">),</span>
                        <span class="n">s_entry</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">fq_filename</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">scan_directory</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                        <span class="n">s_entry</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>

            <span class="n">data</span><span class="o">.</span><span class="n">fq_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">scan_directory</span><span class="o">.</span><span class="n">strip</span><span class="p">()),</span>
                <span class="n">s_entry</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="n">data</span><span class="o">.</span><span class="n">parentdirectory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">scan_directory</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">data</span><span class="o">.</span><span class="n">human_st_mtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">(</span>
                <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">st</span><span class="p">[</span><span class="n">stat</span><span class="o">.</span><span class="n">ST_MTIME</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">s_entry</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files_to_ignore</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">s_entry</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="n">data</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                <span class="n">data</span><span class="o">.</span><span class="n">directoryname</span> <span class="o">=</span> <span class="n">s_entry</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">data</span><span class="o">.</span><span class="n">dot_extension</span> <span class="o">=</span> <span class="s">&quot;.dir&quot;</span>
                <span class="n">data</span><span class="o">.</span><span class="n">file_extension</span> <span class="o">=</span> <span class="s">&quot;dir&quot;</span>

                <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">number_files</span><span class="p">,</span>
                 <span class="n">data</span><span class="o">.</span><span class="n">number_dirs</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_file_dir_count</span><span class="p">(</span>\
                       <span class="n">data</span><span class="o">.</span><span class="n">fq_filename</span><span class="p">)</span>
                <span class="n">directories</span><span class="p">[</span><span class="n">s_entry</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">s_entry</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">data</span><span class="o">.</span><span class="n">directoryname</span> <span class="o">=</span> <span class="n">scan_directory</span>
                <span class="n">data</span><span class="o">.</span><span class="n">dot_extension</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span>\
                                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">s_entry</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">data</span><span class="o">.</span><span class="n">file_extension</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dot_extension</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptable_extensions</span> <span class="o">==</span> <span class="p">[]:</span>
                    <span class="c">#</span>
                    <span class="c">#   There are no non-acceptable files.</span>
                    <span class="c">#</span>
                    <span class="n">files</span><span class="p">[</span><span class="n">s_entry</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">data</span>
                <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">file_extension</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptable_extensions</span><span class="p">:</span>
                    <span class="c">#</span>
                    <span class="c">#   Filter by extensions</span>
                    <span class="c">#</span>
                    <span class="n">files</span><span class="p">[</span><span class="n">s_entry</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_cache</span><span class="p">[</span><span class="n">norm_dir_name</span><span class="p">][</span><span class="s">&quot;files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_cache</span><span class="p">[</span><span class="n">norm_dir_name</span><span class="p">][</span><span class="s">&quot;dirs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">directories</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_cache</span><span class="p">[</span><span class="n">norm_dir_name</span><span class="p">][</span><span class="s">&quot;last_scanned_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_cache</span><span class="p">[</span><span class="n">norm_dir_name</span><span class="p">][</span><span class="s">&quot;last_sort&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_filenames</span><span class="p">(</span><span class="n">scan_directory</span><span class="p">)</span>
        <span class="k">return</span>

<span class="c">#####################################################</span>
    <span class="k">def</span> <span class="nf">_return_file_dir_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan_directory</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            scan_directory (str): The fully qualified pathname to examine</span>

<span class="sd">        Returns:</span>
<span class="sd">            (File_count, dir_count) - Tupple of Integers</span>

<span class="sd">        This is a internal use only function.</span>

<span class="sd">        It returns the number of files, and directories in the scan_directory.</span>
<span class="sd">        This is the actual file system, and not cached directories.</span>

<span class="sd">        * Primarily used to in directory_changed to help highlight directories</span>
<span class="sd">          that have changed, but the last_modified has not been updated.</span>
<span class="sd">        * Also used in _scan_directory_list, to help populate the directory</span>
<span class="sd">          count of files / dirs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scan_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">scan_directory</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">fcount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">dcount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">s_entry</span> <span class="ow">in</span> <span class="n">scandir</span><span class="o">.</span><span class="n">scandir</span><span class="p">(</span><span class="n">scan_directory</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">s_entry</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="n">dcount</span> <span class="o">+=</span> <span class="n">s_entry</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s_entry</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files_to_ignore</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptable_extensions</span> <span class="o">!=</span> <span class="p">[]:</span>
                    <span class="c">#</span>
                    <span class="c">#   There are no non-acceptable files.</span>
                    <span class="c">#</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">s_entry</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span>\
                        <span class="bp">self</span><span class="o">.</span><span class="n">acceptable_extensions</span><span class="p">:</span>
                    <span class="c">#</span>
                    <span class="c">#   Filter by extensions</span>
                    <span class="c">#</span>
                        <span class="k">continue</span>

                <span class="n">fcount</span> <span class="o">+=</span> <span class="n">s_entry</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">fcount</span><span class="p">,</span> <span class="n">dcount</span><span class="p">)</span>

<span class="c">#####################################################</span>
<div class="viewcode-block" id="Cache.directory_in_cache"><a class="viewcode-back" href="../directory_caching.html#directory_caching.Cache.directory_in_cache">[docs]</a>    <span class="k">def</span> <span class="nf">directory_in_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan_directory</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            scan_directory (str): The path of the file to wrap</span>

<span class="sd">        Returns:</span>
<span class="sd">            Boolean</span>

<span class="sd">        Return Values</span>

<span class="sd">        * True - Directory is in the cache</span>
<span class="sd">        * False - Directory is not in the cache</span>

<span class="sd">        This simply returns a boolean, indicating if the scan_directory is</span>
<span class="sd">        present in the cache.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scan_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">scan_directory</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">scan_directory</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_cache</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

<span class="c">#####################################################</span></div>
<div class="viewcode-block" id="Cache.return_current_directory_offset"><a class="viewcode-back" href="../directory_caching.html#directory_caching.Cache.return_current_directory_offset">[docs]</a>    <span class="k">def</span> <span class="nf">return_current_directory_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                        <span class="n">scan_directory</span><span class="p">,</span>
                                        <span class="n">current_directory</span><span class="p">,</span>
                                        <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                        <span class="n">sort_type</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        scan_directory (str): The fully qualified pathname to examine</span>
<span class="sd">        current_directory (str): The current directory name</span>
<span class="sd">        offset (int): The offset modifier</span>
<span class="sd">        sort_type (int): Which sort to apply to the listings</span>

<span class="sd">    Returns, list containing:</span>
<span class="sd">        (Integer, string)</span>

<span class="sd">        Integer: The newly calculated offset</span>
<span class="sd">        String: The Directory name of the new offset</span>

<span class="sd">    return the offset of the next or previous directory, in \</span>
<span class="sd">    scan_directory, where current_directory is the current_directory\</span>
<span class="sd">    that you are residing in from the scan_directory.</span>

<span class="sd">    e.g. /Users/Benjamin is the scan_directory, you are in Movies.  So</span>
<span class="sd">    current_directory is Movies.</span>

<span class="sd">    Used for calculating the previous / next directory in the gallery.</span>

<span class="sd">    offset value examples</span>
<span class="sd">        *  0 - return current directories offset</span>
<span class="sd">        * -1 - return the previous directory</span>
<span class="sd">        * +1 - return the next directory in the list</span>

<span class="sd">    Code::</span>

<span class="sd">       cdl = d_caching.Cache()</span>
<span class="sd">       cdl.smart_read( &quot;/Users/Benjamin&quot; )</span>
<span class="sd">       dirs = cdl.return_sort_name(scan_directory=&quot;/Users/Benjamin&quot;)[1]</span>
<span class="sd">       print dirs[cdl.return_current_directory_offset(</span>
<span class="sd">                    scan_directory = &quot;/Users/Benjamin&quot;,</span>
<span class="sd">                    current_directory=&quot;Movies&quot;, offset=0)]</span>
<span class="sd">       print dirs[cdl.return_current_directory_offset(</span>
<span class="sd">                    scan_directory = &quot;/Users/Benjamin&quot;,</span>
<span class="sd">                    current_directory=&quot;Movies&quot;, offset=2)]</span>
<span class="sd">       print dirs[cdl.return_current_directory_offset(</span>
<span class="sd">                    scan_directory = &quot;/Users/Benjamin&quot;,</span>
<span class="sd">                    current_directory=&quot;Movies&quot;, offset=-2)]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scan_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">scan_directory</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smart_read</span><span class="p">(</span><span class="n">scan_directory</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sort_type</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="c">#   Named Sort - 0, reverse name sort - 1</span>
            <span class="n">dirs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_sort_name</span><span class="p">(</span><span class="n">scan_directory</span><span class="o">=</span><span class="n">scan_directory</span><span class="p">,</span>
                                         <span class="n">reverse</span><span class="o">=</span><span class="n">sort_type</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">sort_type</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
            <span class="n">dirs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_sort_lmod</span><span class="p">(</span><span class="n">scan_directory</span><span class="o">=</span><span class="n">scan_directory</span><span class="p">,</span>
                                         <span class="n">reverse</span><span class="o">=</span><span class="n">sort_type</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">sort_type</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]:</span>
            <span class="n">dirs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_sort_ctime</span><span class="p">(</span><span class="n">scan_directory</span><span class="o">=</span><span class="n">scan_directory</span><span class="p">,</span>
                                          <span class="n">reverse</span><span class="o">=</span><span class="n">sort_type</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">current_offset</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">dir_entry</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dirs</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">dirs</span><span class="p">[</span><span class="n">dir_entry</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span>\
                <span class="n">current_directory</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">current_offset</span> <span class="o">=</span> <span class="n">dir_entry</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">current_offset</span><span class="p">,</span> <span class="n">dirs</span><span class="p">[</span><span class="n">current_offset</span><span class="o">+</span><span class="n">offset</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">current_offset</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">dirs</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c">#</span>
            <span class="c">#   current_offset == None - Empty Directory?</span>
            <span class="c">#           Was not found in the for loop.</span>
            <span class="c">#</span>
            <span class="c">#   len(dirs) == 1, only one directory, there are no previous or</span>
            <span class="c">#       next directories.</span>
            <span class="c">#</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c">#</span>
            <span class="c">#   Negative Offset</span>
            <span class="c">#</span>
            <span class="k">if</span> <span class="n">current_offset</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c"># offset is negative X</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">current_offset</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">dirs</span><span class="p">[</span><span class="n">current_offset</span><span class="o">+</span><span class="n">offset</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">current_offset</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">dirs</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c">#   len is 1 based, current_offset is 0 based.</span>
                <span class="k">return</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">current_offset</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">dirs</span><span class="p">[</span><span class="n">current_offset</span><span class="o">+</span><span class="n">offset</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>


<span class="c">#####################################################</span></div>
<div class="viewcode-block" id="Cache.directory_changed"><a class="viewcode-back" href="../directory_caching.html#directory_caching.Cache.directory_changed">[docs]</a>    <span class="k">def</span> <span class="nf">directory_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan_directory</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        scan_directory (str): The fully qualified pathname to examine</span>

<span class="sd">    Returns:</span>
<span class="sd">        Boolean</span>

<span class="sd">    Return Values</span>

<span class="sd">    * True - The directory has changed since being added to the cache</span>
<span class="sd">    * False - The directory has **not** changed since being added to the cache</span>

<span class="sd">    Pass the target directory as scan_directory.</span>

<span class="sd">    There is two checks being made to decide on the validity of the cache.</span>

<span class="sd">    1. Check the last modified time on the directory vs the</span>
<span class="sd">        **last_scanned_time** in the cached data.</span>
<span class="sd">    2. Check the number of files and directories in the cached copy for any</span>
<span class="sd">       differences.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory_in_cache</span><span class="p">(</span><span class="n">scan_directory</span><span class="p">):</span>
            <span class="c">#   Is in cache</span>
            <span class="n">scan_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">scan_directory</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">scan_directory</span><span class="p">)</span>
            <span class="c">#   Return true if modified time on directory is newer Cached Time.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_cache</span><span class="p">[</span><span class="n">scan_directory</span><span class="p">]</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&quot;last_scanned_time&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">st</span><span class="p">[</span><span class="n">stat</span><span class="o">.</span><span class="n">ST_MTIME</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_cache</span><span class="p">[</span><span class="n">scan_directory</span><span class="p">]</span>\
                    <span class="p">[</span><span class="s">&quot;last_scanned_time&quot;</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_cache</span><span class="p">[</span><span class="n">scan_directory</span><span class="p">][</span><span class="s">&quot;files&quot;</span><span class="p">]),</span>\
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_cache</span><span class="p">[</span><span class="n">scan_directory</span><span class="p">][</span><span class="s">&quot;dirs&quot;</span><span class="p">]))</span> <span class="o">!=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">_return_file_dir_count</span><span class="p">(</span><span class="n">scan_directory</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c">#   Does not exist in Cache, so force a load.</span>
            <span class="k">return</span> <span class="bp">True</span>

<span class="c">#####################################################</span></div>
<div class="viewcode-block" id="Cache.smart_read"><a class="viewcode-back" href="../directory_caching.html#directory_caching.Cache.smart_read">[docs]</a>    <span class="k">def</span> <span class="nf">smart_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan_directory</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        scan_directory (str): The fully qualified pathname to examine</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    This is a wrapper around the Read and changed functions.</span>

<span class="sd">    The scan_directory is passed in, converted to a normalized form,</span>
<span class="sd">    and then checked to see if it exists in the cache.</span>

<span class="sd">    If it doesn&#39;t exist (or is expired), then it is read.</span>

<span class="sd">    If it already exists *AND* has not expired, it is not</span>
<span class="sd">    updated.</span>

<span class="sd">    Net affect, this will ensure the directory is in cache, and</span>
<span class="sd">    update to date.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scan_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">scan_directory</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory_changed</span><span class="p">(</span><span class="n">scan_directory</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scan_directory_list</span><span class="p">(</span><span class="n">scan_directory</span><span class="p">)</span>

<span class="c">#####################################################</span></div>
<div class="viewcode-block" id="Cache.return_sorted"><a class="viewcode-back" href="../directory_caching.html#directory_caching.Cache.return_sorted">[docs]</a>    <span class="k">def</span> <span class="nf">return_sorted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan_directory</span><span class="p">,</span> <span class="n">sort_by</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        scan_directory (str): The fully qualified pathname to examine</span>
<span class="sd">        sort_by (integer / constant):</span>

<span class="sd">                SORT_BY_NAME        = 0</span>
<span class="sd">                SORT_BY_MODIFIED    = 1</span>
<span class="sd">                SORT_BY_CREATION    = 2</span>

<span class="sd">        reverse (bool): Is this an ascending or descending (**reverse**) sort</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tupple: List of sorted Cache entries (text, scandir DirEntry)</span>


<span class="sd">    Return sorted list(s) from the Directory Cache for the</span>
<span class="sd">    Scanned directory, sorted by name.</span>

<span class="sd">    Returns 2 tuples of date, T[0] - Files, and T[1] - Directories</span>
<span class="sd">    which contain the data from the cached directory.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scan_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">scan_directory</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smart_read</span><span class="p">(</span><span class="n">scan_directory</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_cache</span><span class="p">[</span><span class="n">scan_directory</span><span class="p">][</span><span class="s">&quot;last_sort&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">sort_by</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_cache</span><span class="p">[</span><span class="n">scan_directory</span><span class="p">][</span><span class="s">&quot;last_sort&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sort_by</span>
            <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_cache</span><span class="p">[</span><span class="n">scan_directory</span><span class="p">][</span><span class="s">&quot;files&quot;</span><span class="p">]</span>
            <span class="n">dirs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_cache</span><span class="p">[</span><span class="n">scan_directory</span><span class="p">][</span><span class="s">&quot;dirs&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">sort_by</span> <span class="o">==</span> <span class="n">SORT_BY_NAME</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_cache</span><span class="p">[</span><span class="n">scan_directory</span><span class="p">][</span><span class="s">&quot;files&quot;</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="n">natsort</span><span class="o">.</span><span class="n">natsort</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">string</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">filename</span><span class="p">),</span>
                                    <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_cache</span><span class="p">[</span><span class="n">scan_directory</span><span class="p">][</span><span class="s">&quot;dirs&quot;</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="n">natsort</span><span class="o">.</span><span class="n">natsort</span><span class="p">(</span><span class="n">dirs</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">string</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span>\
                                        <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">directoryname</span><span class="p">),</span>
                                    <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">sort_by</span> <span class="o">==</span> <span class="n">SORT_BY_MODIFIED</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_cache</span><span class="p">[</span><span class="n">scan_directory</span><span class="p">][</span><span class="s">&quot;files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>\
                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">st</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_cache</span><span class="p">[</span><span class="n">scan_directory</span><span class="p">][</span><span class="s">&quot;dirs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dirs</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>\
                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">st</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">sort_by</span> <span class="o">==</span> <span class="n">SORT_BY_CREATION</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_cache</span><span class="p">[</span><span class="n">scan_directory</span><span class="p">][</span><span class="s">&quot;files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>\
                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">st</span><span class="o">.</span><span class="n">st_ctime</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_cache</span><span class="p">[</span><span class="n">scan_directory</span><span class="p">][</span><span class="s">&quot;dirs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dirs</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>\
                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">st</span><span class="o">.</span><span class="n">st_ctime</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_cache</span><span class="p">[</span><span class="n">scan_directory</span><span class="p">][</span><span class="s">&quot;files&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_cache</span><span class="p">[</span><span class="n">scan_directory</span><span class="p">][</span><span class="s">&quot;dirs&quot;</span><span class="p">])</span>


<span class="c">#####################################################</span></div>
<div class="viewcode-block" id="Cache.return_sort_name"><a class="viewcode-back" href="../directory_caching.html#directory_caching.Cache.return_sort_name">[docs]</a>    <span class="k">def</span> <span class="nf">return_sort_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan_directory</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Here for backward compatibility versus earlier versions of the library.</span>
<span class="sd">    This will eventually be removed.</span>

<span class="sd">    Args:</span>
<span class="sd">        scan_directory (str): The fully qualified pathname to examine</span>
<span class="sd">        reverse (bool): Is this an ascending or descending (**reverse**) sort</span>

<span class="sd">    Returns:</span>
<span class="sd">        Same as return_sorted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_sorted</span><span class="p">(</span><span class="n">scan_directory</span><span class="p">,</span>
                                  <span class="n">sort_by</span><span class="o">=</span><span class="n">SORT_BY_NAME</span><span class="p">,</span>
                                  <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>

<span class="c">#####################################################</span></div>
<div class="viewcode-block" id="Cache.return_sort_lmod"><a class="viewcode-back" href="../directory_caching.html#directory_caching.Cache.return_sort_lmod">[docs]</a>    <span class="k">def</span> <span class="nf">return_sort_lmod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan_directory</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Here for backward compatibility versus earlier versions of the library.</span>
<span class="sd">    This will eventually be removed.</span>

<span class="sd">    Args:</span>
<span class="sd">        scan_directory (str): The fully qualified pathname to examine</span>
<span class="sd">        reverse (bool): Is this an ascending or descending (**reverse**) sort</span>

<span class="sd">    Returns:</span>
<span class="sd">        Same as return_sorted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_sorted</span><span class="p">(</span><span class="n">scan_directory</span><span class="p">,</span>
                                  <span class="n">sort_by</span><span class="o">=</span><span class="n">SORT_BY_MODIFIED</span><span class="p">,</span>
                                  <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>

<span class="c">#####################################################</span></div>
<div class="viewcode-block" id="Cache.return_sort_ctime"><a class="viewcode-back" href="../directory_caching.html#directory_caching.Cache.return_sort_ctime">[docs]</a>    <span class="k">def</span> <span class="nf">return_sort_ctime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan_directory</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Here for backward compatibility versus earlier versions of the library.</span>
<span class="sd">    This will eventually be removed.</span>

<span class="sd">    Args:</span>
<span class="sd">        scan_directory (str): The fully qualified pathname to examine</span>
<span class="sd">        reverse (bool): Is this an ascending or descending (**reverse**) sort</span>

<span class="sd">    Returns:</span>
<span class="sd">        Same as return_sorted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_sorted</span><span class="p">(</span><span class="n">scan_directory</span><span class="p">,</span>
                                  <span class="n">sort_by</span><span class="o">=</span><span class="n">SORT_BY_CREATION</span><span class="p">,</span>
                                  <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Directory Caching 1.0.0 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2015, Benjamin Schollnick.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.
    </div>
  </body>
</html>